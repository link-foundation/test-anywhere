#!/bin/sh

# Skip in CI environments
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
  exit 0
fi

# Check if this is a merge commit, amend, or rebase
COMMIT_SOURCE=$2
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
  exit 0
fi

# Check if there are any changesets (excluding README.md)
CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | wc -l)

# Check if we're modifying source files, package.json, or tests
MODIFIED_SRC=$(git diff --cached --name-only | grep -E '^(src/|package\.json)' || true)

# If we're modifying source files and there's no changeset, warn the user
if [ -n "$MODIFIED_SRC" ] && [ "$CHANGESET_COUNT" -eq 0 ]; then
  echo ""
  echo "⚠️  WARNING: No changeset found!"
  echo ""
  echo "You are committing changes to source files or package.json"
  echo "but no changeset has been created."
  echo ""
  echo "Modified files:"
  echo "$MODIFIED_SRC" | sed 's/^/  - /'
  echo ""
  echo "To create a changeset, run:"
  echo "  npm run changeset"
  echo ""
  echo "If this commit doesn't require a changeset (e.g., internal refactoring,"
  echo "test updates, or documentation), you can proceed."
  echo ""
  echo "To bypass this check permanently, use: git commit --no-verify"
  echo ""

  # Ask for confirmation (only in interactive mode)
  if [ -t 0 ]; then
    printf "Do you want to continue without a changeset? [y/N] "
    read -r response </dev/tty
    case "$response" in
      [yY][eE][sS]|[yY])
        echo "Proceeding without changeset..."
        exit 0
        ;;
      *)
        echo ""
        echo "Commit aborted. Please create a changeset first with: npm run changeset"
        exit 1
        ;;
    esac
  else
    # Non-interactive mode - fail by default
    echo "Non-interactive mode detected. Please create a changeset first."
    echo "Or use --no-verify to skip this check."
    exit 1
  fi
fi
