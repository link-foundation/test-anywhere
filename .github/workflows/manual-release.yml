name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      description:
        description: 'Release description (optional)'
        required: false
        type: string

jobs:
  create-and-commit-changeset:
    name: Create and Commit Changeset
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Create changeset file
        run: |
          # Get description from workflow input or use default
          DESCRIPTION="${{ github.event.inputs.description }}"

          # Run the create-manual-changeset script
          if [ -n "$DESCRIPTION" ]; then
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}" "$DESCRIPTION"
          else
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}"
          fi

      - name: Commit changeset directly to main
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing changeset..."

            # Stage the changeset file
            git add .changeset/

            # Commit with descriptive message
            DESCRIPTION="${{ github.event.inputs.description }}"
            if [ -n "$DESCRIPTION" ]; then
              git commit -m "chore: add changeset for manual ${{ github.event.inputs.bump_type }} release" \
                         -m "" \
                         -m "Description: $DESCRIPTION" \
                         -m "Triggered by: @${{ github.actor }}"
            else
              git commit -m "chore: add changeset for manual ${{ github.event.inputs.bump_type }} release" \
                         -m "" \
                         -m "Triggered by: @${{ github.actor }}"
            fi

            # Push directly to main
            git push origin main

            echo "✅ Changeset committed and pushed to main"
            echo "The CI/CD workflow will now automatically:"
            echo "  1. Run tests"
            echo "  2. Version the package"
            echo "  3. Publish to npm"
            echo "  4. Create a GitHub release"
          else
            echo "❌ No changes to commit - changeset file may not have been created"
            exit 1
          fi
