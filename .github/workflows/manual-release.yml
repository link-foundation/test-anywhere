name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      description:
        description: 'Release description (optional)'
        required: false
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Create changeset
        run: |
          # Get description from workflow input or use default
          DESCRIPTION="${{ github.event.inputs.description }}"

          # Run the create-manual-changeset script
          if [ -n "$DESCRIPTION" ]; then
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}" "$DESCRIPTION"
          else
            node scripts/create-manual-changeset.mjs "${{ github.event.inputs.bump_type }}"
          fi

      - name: Version packages
        id: version
        run: |
          # Get current version before bump
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $OLD_VERSION"

          # Run changeset version to bump versions and update CHANGELOG
          npm run changeset:version

          # Get new version after bump
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push to main
        id: commit
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing..."

            # Stage all changes
            git add -A

            # Commit with version number as message
            git commit -m "$NEW_VERSION" \
                       -m "" \
                       -m "Manual ${{ github.event.inputs.bump_type }} release"

            # Push directly to main
            git push origin main

            echo "version_committed=true" >> $GITHUB_OUTPUT
            echo "✅ Version bump committed and pushed to main"
          else
            echo "No changes to commit"
            echo "version_committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        if: steps.commit.outputs.version_committed == 'true'
        id: publish
        run: |
          # Publish to npm
          npm run changeset:publish

          echo "published=true" >> $GITHUB_OUTPUT

          # Get published version
          PUBLISHED_VERSION=$(node -p "require('./package.json').version")
          echo "published_version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT
          echo "✅ Published test-anywhere@$PUBLISHED_VERSION to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        if: steps.publish.outputs.published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          echo "Creating GitHub release for $TAG..."

          # Extract changelog entry for this version
          RELEASE_NOTES=$(awk "/## $VERSION/{flag=1; next} /## [0-9]/{flag=0} flag" CHANGELOG.md)

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi

          # Create release
          gh release create "$TAG" \
            --title "$VERSION" \
            --notes "$RELEASE_NOTES" \
            --repo ${{ github.repository }}

          echo "✅ Created GitHub release: $TAG"

      - name: Format GitHub release notes
        if: steps.publish.outputs.published == 'true'
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          # Get the release ID for this version
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG --jq '.id' 2>/dev/null || echo "")

          if [ -n "$RELEASE_ID" ]; then
            echo "Formatting release notes for $TAG..."
            node scripts/format-release-notes.mjs "$RELEASE_ID" "$TAG" "${{ github.repository }}"
            echo "✅ Formatted release notes for $TAG"
          else
            echo "⚠️ Could not find release for $TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
