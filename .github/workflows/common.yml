name: Common Release Steps

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20.x'
      skip-changeset-check:
        description: 'Skip checking for changesets (for manual releases with pre-created changesets)'
        required: false
        type: boolean
        default: false
      commit-message-suffix:
        description: 'Additional message to append to commit message'
        required: false
        type: string
        default: ''
      release_mode:
        description: 'Release mode (instant or changeset)'
        required: false
        type: string
        default: 'changeset'
      bump_type:
        description: 'Version bump type for instant releases (patch, minor, major)'
        required: false
        type: string
        default: 'patch'
      description:
        description: 'Release description for instant releases'
        required: false
        type: string
        default: ''
    outputs:
      published:
        description: 'Whether a package was published'
        value: ${{ jobs.release.outputs.published }}
      published_version:
        description: 'The version that was published'
        value: ${{ jobs.release.outputs.published_version }}
    secrets:
      NPM_TOKEN:
        required: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    outputs:
      published: ${{ steps.publish.outputs.published }}
      published_version: ${{ steps.publish.outputs.published_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Check for changesets
        if: inputs.skip-changeset-check == false
        id: check_changesets
        run: |
          # Count changeset files (excluding README.md and config.json)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)
          echo "Found $CHANGESET_COUNT changeset file(s)"
          echo "has_changesets=$([[ $CHANGESET_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Version packages and commit to main
        if: inputs.skip-changeset-check == true || steps.check_changesets.outputs.has_changesets == 'true'
        id: version
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get current version before bump
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $OLD_VERSION"

          # Branch based on release mode
          if [ "${{ inputs.release_mode }}" == "instant" ]; then
            echo "Running instant version bump..."
            # Run instant version bump script
            if [ -n "${{ inputs.description }}" ]; then
              node scripts/instant-version-bump.mjs "${{ inputs.bump_type }}" "${{ inputs.description }}"
            else
              node scripts/instant-version-bump.mjs "${{ inputs.bump_type }}"
            fi
          else
            echo "Running changeset version..."
            # Run changeset version to bump versions and update CHANGELOG
            npm run changeset:version
          fi

          # Get new version after bump
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing..."

            # Stage all changes (package.json, package-lock.json, CHANGELOG.md, deleted changesets)
            git add -A

            # Build commit message
            COMMIT_MSG="$NEW_VERSION"
            if [ -n "${{ inputs.commit-message-suffix }}" ]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n'$'\n'"${{ inputs.commit-message-suffix }}"
            else
              COMMIT_MSG="$COMMIT_MSG"$'\n'$'\n'"ü§ñ Generated with [Claude Code](https://claude.com/claude-code)"
            fi

            # Commit with version number as message
            git commit -m "$COMMIT_MSG"

            # Push directly to main
            git push origin main

            echo "‚úÖ Version bump committed and pushed to main"
            echo "version_committed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "version_committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        if: steps.version.outputs.version_committed == 'true'
        id: publish
        run: |
          # Pull the latest changes we just pushed (only needed for automated flow)
          if [ "${{ inputs.skip-changeset-check }}" == "false" ]; then
            git pull origin main
          fi

          # Publish to npm
          npm run changeset:publish

          echo "published=true" >> $GITHUB_OUTPUT

          # Get published version
          PUBLISHED_VERSION=$(node -p "require('./package.json').version")
          echo "published_version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Published test-anywhere@$PUBLISHED_VERSION to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        if: steps.publish.outputs.published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          echo "Creating GitHub release for $TAG..."

          # Extract changelog entry for this version
          # Read from CHANGELOG.md between this version header and the next version header
          RELEASE_NOTES=$(awk "/## $VERSION/{flag=1; next} /## [0-9]/{flag=0} flag" CHANGELOG.md)

          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Release $VERSION"
          fi

          # Create release
          gh release create "$TAG" \
            --title "$VERSION" \
            --notes "$RELEASE_NOTES" \
            --repo ${{ github.repository }}

          echo "‚úÖ Created GitHub release: $TAG"

      - name: Format GitHub release notes
        if: steps.publish.outputs.published == 'true'
        run: |
          VERSION="${{ steps.publish.outputs.published_version }}"
          TAG="v$VERSION"

          # Get the release ID for this version
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG --jq '.id' 2>/dev/null || echo "")

          if [ -n "$RELEASE_ID" ]; then
            echo "Formatting release notes for $TAG..."
            node scripts/format-release-notes.mjs "$RELEASE_ID" "$TAG" "${{ github.repository }}"
            echo "‚úÖ Formatted release notes for $TAG"
          else
            echo "‚ö†Ô∏è Could not find release for $TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
